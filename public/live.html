<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Create Next App</title>
    <meta name="description" content="Generated by create next app" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16" />
    <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>

  </head>
  <body class="__className_36bd41">
    <div class="w-screen h-screen p-5 bg-gray-800">
      <div class="w-full h-[calc(100%-70px)] flex flex-col gap-4">
        <div class="flex gap-4 w-full h-full">
          <div
            class="h-[calc(100vh-110px)] xs:h-[calc(100vh-150px)] w-[calc(100%-400px)]"
          >
            <div class="w-full h-full flex flex-col gap-5">
              <div class="w-full h-full relative z-0 text-[16px] xs:text-[9px]">
                <video
                  id="sharing"
                  autoplay=""
                  playsinline=""
                  class="rounded-xl w-full h-full object-fill"
                  controls
                ></video>

                <div
                  class="flex absolute top-2 left-2 bg-red-700 p-[0.5em] rounded-[0.5625rem] z-10"
                >
                  <p id="liveCount" class="text-[0.8em] text-gray-200">Live</p>
                </div>
              </div>
            </div>
          </div>
          <div
            class="2xl:w-[400px] xl:w-[400px] lg:w-[300px] md:w-[300px] sm:w-full xs:w-[calc(100%-40px)] sm:fixed xs:fixed md:relative bg-white rounded-xl p-8 h-full"
          >
              <div class="">
                <div class="flex justify-between items-center">
                  <h5 class="text-lg">People</h5>
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 1024 1024"
                    fill-rule="evenodd"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M799.855 166.312c.023.007.043.018.084.059l57.69 57.69c.041.041.052.06.059.084a.118.118 0 0 1 0 .069c-.007.023-.018.042-.059.083L569.926 512l287.703 287.703c.041.04.052.06.059.083a.118.118 0 0 1 0 .07c-.007.022-.018.042-.059.083l-57.69 57.69c-.041.041-.06.052-.084.059a.118.118 0 0 1-.069 0c-.023-.007-.042-.018-.083-.059L512 569.926 224.297 857.629c-.04.041-.06.052-.083.059a.118.118 0 0 1-.07 0c-.022-.007-.042-.018-.083-.059l-57.69-57.69c-.041-.041-.052-.06-.059-.084a.118.118 0 0 1 0-.069c.007-.023.018-.042.059-.083L454.073 512 166.371 224.297c-.041-.04-.052-.06-.059-.083a.118.118 0 0 1 0-.07c.007-.022.018-.042.059-.083l57.69-57.69c.041-.041.06-.052.084-.059a.118.118 0 0 1 .069 0c.023.007.042.018.083.059L512 454.073l287.703-287.702c.04-.041.06-.052.083-.059a.118.118 0 0 1 .07 0Z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div id='inbox' class='w-full h-[calc(100%-80px)] py-5'></div>
              <div class='flex justify-between items-center'>
                <input
                id="messageBox"
                class="bg-gray-200 text-gray-900 text-sm rounded-lg focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:border-blue-500 outline-none"
                placeholder="Send a message"
                type="text"
              />
              <div id='sendBtn' class="px-2 cursor-pointer" >
                <svg class="h-7 w-7 text-gray-700"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round">  <line x1="22" y1="2" x2="11" y2="13" />  <polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>
              </div>
              </div>
            </div>
          </div>
        </div>
        <div class="w-full h-[70px] grid grid-cols-3 rounded-xl">
          <div class="col-start-1">
            <div class="h-full flex items-center">
              <div class="flex flex-col content-center">
                <p class="text-lg text-gray-300">Live Stream</p>
              </div>
            </div>
          </div>
          <div class="col-start-2">
            <div class="h-full flex justify-center items-center">
              <div class="flex gap-3">
                <button
                  class="bg-gray-600 p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 256 256"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M192,72V184a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V72A16,16,0,0,1,32,56H176A16,16,0,0,1,192,72Zm58,.25a8.23,8.23,0,0,0-6.63,1.22L209.78,95.86A4,4,0,0,0,208,99.19v57.62a4,4,0,0,0,1.78,3.33l33.78,22.52a8,8,0,0,0,8.58.19,8.33,8.33,0,0,0,3.86-7.17V80A8,8,0,0,0,250,72.25Z"
                    ></path>
                  </svg></button
                ><button
                  class="bg-gray-600 p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 24 24"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M16 12V6c0-2.217-1.785-4.021-3.979-4.021a.933.933 0 0 0-.209.025A4.006 4.006 0 0 0 8 6v6c0 2.206 1.794 4 4 4s4-1.794 4-4zm-6 0V6c0-1.103.897-2 2-2a.89.89 0 0 0 .163-.015C13.188 4.06 14 4.935 14 6v6c0 1.103-.897 2-2 2s-2-.897-2-2z"
                    ></path>
                    <path
                      d="M6 12H4c0 4.072 3.061 7.436 7 7.931V22h2v-2.069c3.939-.495 7-3.858 7-7.931h-2c0 3.309-2.691 6-6 6s-6-2.691-6-6z"
                    ></path>
                  </svg></button
                ><button
                  class="bg-gray-600 p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="none"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M13 3H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-3"
                    ></path>
                    <path d="M8 21h8"></path>
                    <path d="M12 17v4"></path>
                    <path d="m17 8 5-5"></path>
                    <path d="M17 3h5v5"></path>
                  </svg></button
                ><button
                  class="p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full bg-red-600"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 256 256"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M236.28,177.85a16,16,0,0,1-18.38,5.07l-24.76-19a3.43,3.43,0,0,1-.53-.48L109.18,71.62a4,4,0,0,1,2.55-6.68c43-4.62,87.74,9.12,119.86,41.24h0C251.58,126.17,253.51,155.64,236.28,177.85ZM53.93,34.62A8,8,0,1,0,42.09,45.38L69.71,75.77a142,142,0,0,0-45.3,30.41c-20,20-21.92,49.46-4.69,71.67a16,16,0,0,0,18.38,5.07l49-17.37.29-.11a16,16,0,0,0,9.75-11.72l5.9-29.51a73.64,73.64,0,0,1,8.57-2.39l90.5,99.56a8,8,0,1,0,11.84-10.76Z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="col-start-3">
            <div class="h-full flex justify-end items-center">
              <div class="flex gap-3">
                <button
                  class="p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full bg-transparent"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    version="1.1"
                    viewBox="0 0 16 16"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M7 4.75c0-0.412 0.338-0.75 0.75-0.75h0.5c0.412 0 0.75 0.338 0.75 0.75v0.5c0 0.412-0.338 0.75-0.75 0.75h-0.5c-0.412 0-0.75-0.338-0.75-0.75v-0.5z"
                    ></path>
                    <path d="M10 12h-4v-1h1v-3h-1v-1h3v4h1z"></path>
                    <path
                      d="M8 0c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM8 14.5c-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5z"
                    ></path>
                  </svg></button
                ><button
                  class="p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full bg-transparent"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 24 24"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path fill="none" d="M0 0h24v24H0V0z"></path>
                    <path
                      d="M4 4h16v12H5.17L4 17.17V4m0-2c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4zm2 10h8v2H6v-2zm0-3h12v2H6V9zm0-3h12v2H6V6z"
                    ></path>
                  </svg></button
                ><button
                  class="p-3 text-center text-sm text-white transition-all shadow-sm hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none rounded-full bg-transparent"
                  type="button"
                >
                  <svg
                    stroke="currentColor"
                    fill="none"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-xl"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * @file This shows how, when using the segments mode of SourceBuffer, and appending disparate files, you need to manage offsets yourself
       */

      const DURATION_VIDEO = 1;
      var currentSegments = {};
      var max = 0;

      const addSourceBufferWhenOpen = (
        mediaSource,
        mimeStr,
        mode = 'segments'
      ) => {
        return new Promise((resolve) => {
          mediaSource.addEventListener('sourceopen', () => {
            const sourceBuffer = mediaSource.addSourceBuffer(mimeStr);
            sourceBuffer.mode = mode;
            resolve(sourceBuffer);
          });
        });
      };

      function fetchWithRetry(url, options = {}, retries = 1000, delay = 1000) {
        return new Promise((resolve, reject) => {
          const attemptFetch = (remainingRetries) => {
            fetch(url, options)
              .then((response) => {
                if (!response.ok) {
                  // Nếu mã trạng thái không phải là 200 (thành công), ném lỗi
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                resolve(response); // Trả về phản hồi nếu thành công
              })
              .catch((error) => {
                if (remainingRetries > 0) {
                  console.log(`Lỗi: ${error.message}. Thử lại...`);
                  setTimeout(() => attemptFetch(remainingRetries - 1), delay); // Thử lại sau một khoảng thời gian
                } else {
                  reject(`Lỗi sau ${retries} lần thử: ${error.message}`); // Nếu hết retries thì từ bỏ
                }
              });
          };

          attemptFetch(retries); // Bắt đầu thử lại
        });
      }

      const loadCurrentSegment = async () => {
        const response = await fetch('/api/current_stream');
        const json = await response.json();
        currentSegments = json;
      };

      const startLive = async (target, path, currentSegmentCount) => {
        const video = document.getElementById(target);
        let segmentCount = 1;

        // Normal setup, with MediaSource, Object URL, and prepped SourceBuffer
        const mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);
        // mode = segments
        const sourceBuffer = await addSourceBufferWhenOpen(
          mediaSource,
          `video/webm; codecs="vp8,vorbis"`,
          'segments'
        );

        sourceBuffer.onupdateend = async () => {
          sourceBuffer.timestampOffset += DURATION_VIDEO;
          // Now we can move on to next clip and append it
          segmentCount++;
            
          await append();
        };

        sourceBuffer.onerror = function(e) {
          console.log("Error in sourceBuffer: ", e);
        };

        const load = async (segmentNo) => {
          const response = await fetchWithRetry(
            `/${path}/segment_${segmentNo}.webm`
          );
          const blob = await response.blob();
          const buffer = await blob.arrayBuffer();
          return buffer;
        };

        const append = async () => {
          const buffer = await load(segmentCount);
          sourceBuffer.appendBuffer(buffer);
        };
  
        const appendCurrentSegments = async () => {
          segmentCount = currentSegmentCount - 2;                  

          video.addEventListener('waiting', async () => {
            console.log('Video đang tải...');
          });
  
          // Sự kiện khi video bắt đầu phát
          video.addEventListener('playing', function () {
            console.log('Video đang phát');
          });

          setTimeout(append, 5000)
        };

        // This will kick off event listener chain above
        await appendCurrentSegments();
      };

      const start = async () => {
        await loadCurrentSegment();
        console.log('currentSegments', currentSegments)
        await startLive("sharing", "live_stream", currentSegments.liveWebcamCount);
        // await startLive("sharing", "live_sharing", currentSegments.sharingCount);
      };

      start();

      
    </script>
  </body>
</html>
